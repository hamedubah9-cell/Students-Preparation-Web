<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smythe University College (S.U.C) ‚Äî Freshman Students Preparation Web (Firebase)</title>

<!-- Minimal styling -->
<style>
  :root{--bg:#f7fbff;--card:#fff;--accent:#0b63d6;--muted:#556;--gold:#d97706}
  body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#07203b}
  .wrap{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:grid;place-items:center;color:white;font-weight:800}
  nav{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.alt{background:#fff;color:var(--accent);border:1px solid rgba(11,99,214,0.12)}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.06);margin-top:14px}
  .courses{display:flex;gap:8px;flex-wrap:wrap}
  .course{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,0.8),transparent)}
  .panel{display:flex;gap:12px}
  .left{flex:1}
  .right{width:360px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin:6px 0}
  .chat{height:300px;overflow:auto;border-radius:8px;padding:8px;border:1px solid rgba(2,6,23,0.06);background:#fbfdff}
  .msg{padding:6px;border-radius:8px;margin-bottom:6px}
  .msg.system{background:#f1f5f9;color:#333;font-style:italic}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px}
  .avatar{width:40px;height:40;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 4px 10px rgba(2,6,23,0.08)}
  .profile{display:flex;gap:10px;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .hidden{display:none}
  pre{white-space:pre-wrap;padding:10px;background:#f8fafc;border-radius:8px}
  .course-chat-select{display:flex;gap:8px;align-items:center}
  .moderator-badge{display:inline-block;padding:4px 8px;background:#ffe6b3;color:#996600;border-radius:999px;font-size:12px}
  .file-drop{border:2px dashed rgba(11,99,214,0.12);padding:12px;border-radius:10px;text-align:center;margin-top:8px;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
  .editor{min-height:160px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);padding:8px;background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">SUC</div>
      <div>
        <h1 style="margin:0">Smythe University College ‚Äî Freshman Students Preparation Web</h1>
        <div class="muted">Prepared by Student Akin S. Sokpah</div>
      </div>

      <nav>
        <div id="userPanel" style="display:flex;gap:10px;align-items:center">
          <div id="userInfo" class="muted">Not signed in</div>
          <button id="btnAuth" class="btn">Sign In / Sign Up</button>
          <button id="btnSignOut" class="btn alt hidden">Sign Out</button>
        </div>
      </nav>
    </header>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Courses</strong>
        <div class="muted small">Click a course to view content and join course chat</div>
      </div>

      <div style="margin-top:12px" class="courses">
        <div class="course" data-course="English.101">üß† English.101</div>
        <div class="course" data-course="Mathematics.101">üßÆ Mathematics.101</div>
        <div class="course" data-course="Biology.101">üß¨ Biology.101</div>
        <div class="course" data-course="Chemistry.101">‚öóÔ∏è Chemistry.101 (placeholder)</div>
        <div class="course" data-course="PE.101">üèÉ PE.101 (placeholder)</div>
        <div class="course" data-course="COSC.101">üíª COSC.101 (placeholder)</div>
        <div class="course" data-course="LabBio.101">üî¨ Lab Biology (placeholder)</div>
        <div class="course" data-course="LabChem.101">üß™ Lab Chemistry (placeholder)</div>
      </div>
    </section>

    <div class="card panel">
      <!-- left: course content -->
      <div class="left">
        <div id="courseContent" class="card">
          <h3 id="courseTitle">Select a course</h3>

          <!-- ENGLISH content (already populated) -->
          <div id="English.101.content" class="course-panel hidden">
            <h4>English.101 ‚Äî Nouns, Verbs, Mood, Agreement</h4>
            <div class="muted small">Complete Q&A (loaded from earlier materials)</div>
            <div style="margin-top:12px">
              <strong>Example Qs (full set included in the app):</strong>
              <div class="qa"><strong>1.</strong> What does the Latin root <em>nomen</em> mean? ‚Äî <em>Answer:</em> Name.</div>
              <div class="qa"><strong>2.</strong> Which of the following is not a noun? ‚Äî <em>Answer:</em> Run (primarily a verb).</div>
              <div class="qa"><strong>3.</strong> ... (full English questions & answers are included)</div>
              <pre id="englishFull"></pre>
            </div>
          </div>

          <!-- MATH content -->
          <div id="Mathematics.101.content" class="course-panel hidden">
            <h4>Mathematics.101 ‚Äî Fractions, Percentages, Interest, Standard Form</h4>
            <div class="muted small">Corrected and formatted math questions and answers</div>
            <div style="margin-top:10px">
              <pre id="mathFull"></pre>
            </div>
          </div>

          <!-- BIOLOGY content -->
          <div id="Biology.101.content" class="course-panel hidden">
            <h4>Biology.101 ‚Äî Question Bank</h4>
            <div class="muted small">You can import a DOCX file (client-side) or paste the content below</div>

            <div style="margin-top:10px">
              <div class="file-drop" id="bioDrop">
                <div><strong>Import Biology DOCX</strong></div>
                <div class="muted small">Click to select the DOCX file (e.g., "2025 boilogy question Banks.docx") or drag & drop it here. The file is parsed in your browser and saved to the Biology course content in Firestore.</div>
                <input type="file" id="bioFileInput" accept=".docx" style="margin-top:8px"/>
                <div style="margin-top:8px">
                  <button class="btn" id="importBioBtn">Import & Save to Biology.101 (Firestore)</button>
                </div>
              </div>

              <div style="margin-top:12px">
                <div><strong>Or paste / edit Biology content (rich text):</strong></div>
                <div id="bioEditor" class="editor" contenteditable="true" placeholder="Paste biology bank here..."></div>
                <div class="controls">
                  <button class="btn" id="saveBioBtn">Save Biology Content to Firestore</button>
                  <button class="btn alt" id="loadBioBtn">Load Saved Biology Content</button>
                </div>
              </div>

              <div style="margin-top:12px">
                <strong>Biology (current saved content):</strong>
                <div id="bioSaved" style="margin-top:10px"></div>
              </div>
            </div>
          </div>

          <!-- default -->
          <div id="placeholderPanel" class="course-panel">
            <p class="muted">Choose a course from the menu on top to view content and join the course chat.</p>
          </div>
        </div>

        <!-- profile / edit -->
        <div class="card" style="margin-top:12px">
          <h4>Your Profile</h4>
          <div id="profileArea">
            <div class="profile" id="profilePreview"><img id="avatarImg" class="avatar hidden" alt="avatar"/><div id="profileName" class="muted">Not signed in</div></div>

            <div id="profileEditor" class="hidden" style="margin-top:8px">
              <input id="editName" placeholder="Full name"/>
              <select id="editCourse">
                <option>English.101</option><option>Mathematics.101</option><option>Biology.101</option><option>Chemistry.101</option>
              </select>
              <div style="display:flex;gap:8px;align-items:center">
                <input type="file" id="avatarFile" accept="image/*"/>
                <button class="btn" id="uploadAvatarBtn">Upload Avatar</button>
              </div>
              <div class="controls">
                <button class="btn" id="saveProfileBtn">Save Profile</button>
                <button class="btn alt" id="cancelEditProfile">Cancel</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- right: chat & controls -->
      <div class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Group Chat</strong>
            <div class="muted small">Public room & course rooms</div>
          </div>

          <div style="margin-top:8px" class="course-chat-select">
            <label for="chatCourse" class="small muted">Room:</label>
            <select id="chatCourse">
              <option value="group_chat">Public ‚Äî S.U.C Group</option>
              <option value="group_chat/English.101">English.101</option>
              <option value="group_chat/Mathematics.101">Mathematics.101</option>
              <option value="group_chat/Biology.101">Biology.101</option>
            </select>
          </div>

          <div id="chatBox" class="chat" style="margin-top:8px"></div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="chatInput" placeholder="Write message..." />
            <button class="btn" id="sendChatBtn">Send</button>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn alt" id="clearChatLocal">Clear view</button>
            <div id="moderatorTools" style="margin-left:auto;display:none">
              <button class="btn" id="purgeRoomBtn" title="Delete all messages in this room (moderator only)">Purge Room</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Admin / Moderation</strong>
          <div class="muted small">Users with <code>role: "moderator"</code> in their profile can delete messages and purge rooms.</div>
          <div style="margin-top:8px">
            <button class="btn alt" id="requestModBtn">Request moderator (sends request)</button>
            <div id="modMsg" class="muted small" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Auth modal -->
    <div id="authModal" class="card hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);display:grid;place-items:center">
      <div style="max-width:420px;width:100%;padding:14px;background:var(--card);border-radius:10px">
        <h3 id="authTitle">Sign Up</h3>
        <div class="muted small" id="authSubtitle">Create an account or sign in</div>
        <input id="authName" placeholder="Full name"/>
        <input id="authEmail" placeholder="Email"/>
        <input id="authPassword" placeholder="Password" type="password"/>
        <select id="authCourse"><option>English.101</option><option>Mathematics.101</option><option>Biology.101</option></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="authActionBtn">Create account</button>
          <button class="btn alt" id="authToggleBtn">Switch to Sign In</button>
          <button class="btn alt" id="authCloseBtn">Close</button>
        </div>
        <div id="authFeedback" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>

  </div>

  <!-- Include Mammoth for client-side docx -> html conversion -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- Firebase v9 modular from CDN -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, addDoc, updateDoc, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getDatabase, ref, push, onChildAdded, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
    import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

    // ---- Your Firebase config (you provided earlier) ----
    const firebaseConfig = {
      apiKey: "AIzaSyC7cAN-mrE2PvmlQ11zLKAdHBhN7nUFjHw",
      authDomain: "fir-u-c-students-web.firebaseapp.com",
      projectId: "fir-u-c-students-web",
      storageBucket: "fir-u-c-students-web.firebasestorage.app",
      messagingSenderId: "113569186739",
      appId: "1:113569186739:web:d8daf21059f43a79e841c6"
    };

    // Initialize firebase services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    const rdb = getDatabase(app);
    const storage = getStorage(app);

    // UI refs
    const btnAuth = document.getElementById('btnAuth');
    const btnSignOut = document.getElementById('btnSignOut');
    const userInfo = document.getElementById('userInfo');
    const authModal = document.getElementById('authModal');
    const authTitle = document.getElementById('authTitle');
    const authActionBtn = document.getElementById('authActionBtn');
    const authToggleBtn = document.getElementById('authToggleBtn');
    const authCloseBtn = document.getElementById('authCloseBtn');
    const authName = document.getElementById('authName');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const authCourse = document.getElementById('authCourse');
    const authFeedback = document.getElementById('authFeedback');

    const profilePreview = document.getElementById('profilePreview');
    const profileName = document.getElementById('profileName');
    const avatarImg = document.getElementById('avatarImg');
    const profileEditor = document.getElementById('profileEditor');
    const editName = document.getElementById('editName');
    const editCourse = document.getElementById('editCourse');
    const avatarFile = document.getElementById('avatarFile');
    const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const cancelEditProfile = document.getElementById('cancelEditProfile');

    const courseEls = document.querySelectorAll('.course');
    const courseTitle = document.getElementById('courseTitle');
    const coursePanels = document.querySelectorAll('.course-panel');
    const placeholderPanel = document.getElementById('placeholderPanel');

    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const chatCourseSelect = document.getElementById('chatCourse');
    const purgeRoomBtn = document.getElementById('purgeRoomBtn');
    const moderatorTools = document.getElementById('moderatorTools');
    const modMsg = document.getElementById('modMsg');
    const requestModBtn = document.getElementById('requestModBtn');

    // Biology import UI
    const bioFileInput = document.getElementById('bioFileInput');
    const importBioBtn = document.getElementById('importBioBtn');
    const bioEditor = document.getElementById('bioEditor');
    const saveBioBtn = document.getElementById('saveBioBtn');
    const loadBioBtn = document.getElementById('loadBioBtn');
    const bioSaved = document.getElementById('bioSaved');

    // Math and English content containers
    const mathFull = document.getElementById('mathFull');
    const englishFull = document.getElementById('englishFull');

    // populate math & english text (the corrected math content and the english content from earlier)
    englishFull.textContent = `Full English.101 Q&A included: Section 1 ‚Äî Definition & Function of Nouns
1. What does the Latin root 'nomen' mean? ‚Äî Name.
2. Which of the following is not a noun? ‚Äî Run (primarily a verb).
... (rest of the English content: all questions & answers from the previous English bank are included here for review and study).
`;
    mathFull.textContent = `Mathematics.101 ‚Äî Fractions: Types & Operations (selected)
Types of fractions: proper, improper, like, unlike, mixed numbers.
Examples (addition, subtraction, multiplication, division) as corrected:
2/5 + 1/2 = 9/10
4/5 + 2/5 = 6/5 = 1 1/5
3 1/2 + 2 2/3 + 1 5/6 = 7 1/4
...
Quiz answers:
- Value of digit 5 in 795264 => 5 thousands (5,000)
- Roman numeral for 19 => XIX
- 2/3 √∑ 1/4 => 8/3
- Evaluate 9*6 - 4 + 8/2 => 54
(Full math bank included in the application)
`;

    // Helper: show a specific course panel
    function showCourse(courseId){
      courseTitle.textContent = courseId;
      coursePanels.forEach(p => p.classList.add('hidden'));
      placeholderPanel.classList.add('hidden');
      const el = document.getElementById(courseId + '.content');
      if (el){
        el.classList.remove('hidden');
      } else {
        placeholderPanel.classList.remove('hidden');
      }
    }

    // Course card clicks
    courseEls.forEach(c => {
      c.addEventListener('click', () => {
        const id = c.getAttribute('data-course');
        showCourse(id);
        // switch chat room to course room
        const roomVal = id === 'English.101' || id === 'Mathematics.101' || id === 'Biology.101' ? 'group_chat/' + id : 'group_chat';
        chatCourseSelect.value = roomVal;
        switchChatRoom(roomVal);
      });
    });

    // Auth modal state
    let isSignUp = true;
    btnAuth.addEventListener('click', ()=>{ authModal.classList.remove('hidden'); authTitle.textContent='Sign Up'; authActionBtn.textContent='Create account'; authFeedback.textContent=''; isSignUp=true; });
    authToggleBtn.addEventListener('click', ()=>{ isSignUp = !isSignUp; authTitle.textContent = isSignUp ? 'Sign Up' : 'Sign In'; authActionBtn.textContent = isSignUp ? 'Create account' : 'Sign in'; });
    authCloseBtn.addEventListener('click', ()=>{ authModal.classList.add('hidden'); });

    // Create or Sign In
    authActionBtn.addEventListener('click', async ()=>{
      authFeedback.textContent = '';
      const name = authName.value.trim();
      const email = authEmail.value.trim();
      const pw = authPassword.value;
      const course = authCourse.value;
      if (!email || !pw) { authFeedback.textContent = 'Email and password required.'; return; }
      try {
        if (isSignUp) {
          const cred = await createUserWithEmailAndPassword(auth, email, pw);
          const uid = cred.user.uid;
          // check if any student exists; if none, assign moderator role to first registered user
          const studentsSnap = await getDocs(collection(firestore,'students'));
          const role = (studentsSnap.empty) ? 'moderator' : 'student';
          await setDoc(doc(firestore,'students',uid), { name, email, course, role, createdAt: new Date().toISOString() });
          authFeedback.textContent = 'Account created. Welcome, ' + (name || email);
          authModal.classList.add('hidden');
        } else {
          await signInWithEmailAndPassword(auth, email, pw);
          authFeedback.textContent = 'Signed in.';
          authModal.classList.add('hidden');
        }
      } catch (e){
        authFeedback.textContent = e.message;
      }
    });

    // Sign out
    btnSignOut.addEventListener('click', async ()=> { await signOut(auth); });

    // Observe auth state
    let currentUser = null;
    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user){
        btnAuth.classList.add('hidden');
        btnSignOut.classList.remove('hidden');
        const uid = user.uid;
        const pdoc = await getDoc(doc(firestore,'students',uid));
        const data = pdoc.exists() ? pdoc.data() : {name: user.email, role:'student', course:''};
        userInfo.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div><img id="smallAvatar" src="${data.avatar || ''}" alt="" style="${data.avatar? '' : 'display:none'};width:32px;height:32px;border-radius:50%"></div><div><strong>${data.name || user.email}</strong><div class="muted small">${data.course || ''} ${data.role === 'moderator' ? '<span class="moderator-badge">MOD</span>' : ''}</div></div></div>`;
        profileName.textContent = data.name || user.email;
        if (data.avatar) { avatarImg.src = data.avatar; avatarImg.classList.remove('hidden'); }
        profileEditor.classList.remove('hidden');
        editName.value = data.name || '';
        editCourse.value = data.course || '';
        // post join message to public group chat & course-specific chat
        const joinMsgRef = ref(rdb, 'group_chat/messages');
        await push(joinMsgRef, { sender: 'System', message: `${data.name || user.email} joined S.U.C`, ts: Date.now(), uid });
        // Show moderator tools if role is moderator
        if (data.role === 'moderator') { moderatorTools.style.display = 'block'; }
        else { moderatorTools.style.display = 'none'; }
      } else {
        btnAuth.classList.remove('hidden');
        btnSignOut.classList.add('hidden');
        userInfo.textContent = 'Not signed in';
        profileName.textContent = 'Not signed in';
        avatarImg.classList.add('hidden');
        profileEditor.classList.add('hidden');
        moderatorTools.style.display = 'none';
      }
    });

    // Profile editing and avatar upload
    uploadAvatarBtn.addEventListener('click', async ()=>{
      if (!currentUser) { alert('Sign in to upload avatar'); return; }
      const file = avatarFile.files[0];
      if (!file) { alert('Choose an image first'); return; }
      const uid = currentUser.uid;
      const storageRef = sref(storage, `avatars/${uid}/${file.name}`);
      const snapshot = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snapshot.ref);
      // update user doc
      await updateDoc(doc(firestore,'students',uid), { avatar: url });
      avatarImg.src = url; avatarImg.classList.remove('hidden');
      document.getElementById('smallAvatar').src = url;
      alert('Avatar uploaded');
    });

    saveProfileBtn.addEventListener('click', async ()=>{
      if (!currentUser) { alert('Sign in to save profile'); return; }
      const uid = currentUser.uid;
      const name = editName.value.trim();
      const course = editCourse.value;
      await updateDoc(doc(firestore,'students',uid), { name, course });
      alert('Profile updated');
    });

    cancelEditProfile.addEventListener('click', ()=>{ profileEditor.classList.add('hidden'); });

    // Chat logic (Realtime DB)
    let currentRoom = 'group_chat';
    let messageListeners = {};
    function formatMessageHtml(msgData, key){
      const sender = msgData.sender || 'Unknown';
      const text = msgData.message || '';
      const time = msgData.ts ? new Date(msgData.ts).toLocaleString() : '';
      const uid = msgData.uid || '';
      const isSystem = sender === 'System';
      const el = document.createElement('div');
      el.className = 'msg ' + (isSystem ? 'system' : '');
      el.setAttribute('data-key', key || '');
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${sender}</strong> <small class="muted">${time}</small></div></div><div style="margin-top:4px">${text}</div>`;
      // delete button for moderators
      if (window.currentProfileRole === 'moderator') {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.cssText = 'float:right;margin-top:6px;background:#e74c3c;color:white;border:none;padding:4px 6px;border-radius:6px;cursor:pointer';
        delBtn.addEventListener('click', async ()=> {
          if (!confirm('Delete this message?')) return;
          // remove node by key
          const nodeRef = ref(rdb, currentRoom + '/messages/' + key);
          await remove(nodeRef);
        });
        el.appendChild(delBtn);
      }
      return el;
    }

    async function switchChatRoom(room){
      // remove previous listeners (we use onChildAdded which we cannot easily detach by callback; basic approach: clear the chat and set new onChildAdded)
      chatBox.innerHTML = '';
      currentRoom = room;
      const rRef = ref(rdb, room + '/messages');
      onChildAdded(rRef, (snap) => {
        const key = snap.key;
        const val = snap.val();
        const msgEl = formatMessageHtml(val, key);
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    // default
    switchChatRoom('group_chat');

    // send message
    sendChatBtn.addEventListener('click', async ()=>{
      const text = chatInput.value.trim();
      if (!text) return;
      let sender = 'Guest';
      let uid = null;
      if (currentUser){
        const ud = await getDoc(doc(firestore,'students',currentUser.uid));
        const data = ud.exists() ? ud.data() : null;
        sender = data?.name || currentUser.email;
        uid = currentUser.uid;
      }
      const msgRef = ref(rdb, chatCourseSelect.value + '/messages');
      await push(msgRef, { sender, message: text, ts: Date.now(), uid });
      chatInput.value = '';
    });

    // room select change
    chatCourseSelect.addEventListener('change', ()=>{ switchChatRoom(chatCourseSelect.value); });

    // clear local view
    document.getElementById('clearChatLocal').addEventListener('click', ()=>{ chatBox.innerHTML=''; });

    // Purge room (moderator)
    purgeRoomBtn.addEventListener('click', async ()=>{
      if (!currentUser) { alert('Sign in as moderator to purge'); return; }
      // check role
      const pdoc = await getDoc(doc(firestore,'students',currentUser.uid));
      const role = pdoc.exists() ? pdoc.data().role : '';
      if (role !== 'moderator'){ alert('Only moderators can purge rooms'); return; }
      if (!confirm('Delete all messages in this room?')) return;
      // remove entire messages node
      const roomRef = ref(rdb, chatCourseSelect.value + '/messages');
      await remove(roomRef);
      alert('Room purged');
    });

    // request mod (sends a system message ‚Äî manual promotion via Firestore console)
    requestModBtn.addEventListener('click', async ()=>{
      if (!currentUser) { modMsg.textContent = 'Sign in to request moderator.'; return; }
      const pdoc = await getDoc(doc(firestore,'students',currentUser.uid));
      const name = pdoc.exists() ? pdoc.data().name : currentUser.email;
      const msgRef = ref(rdb, 'group_chat/messages');
      await push(msgRef, { sender: 'System', message: `${name} has requested moderator privileges. Grant via Firestore console if appropriate.`, ts: Date.now(), uid: currentUser.uid });
      modMsg.textContent = 'Request sent (moderators will review via Firebase Console).';
    });

    // Import Biology DOCX using Mammoth (client-side)
    importBioBtn.addEventListener('click', async ()=>{
      const file = bioFileInput.files[0];
      if (!file) { alert('Choose a .docx file first'); return; }
      try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.convertToHtml({ arrayBuffer });
        const html = result.value;
        // display in editor
        bioEditor.innerHTML = html;
        // save to Firestore under a course doc
        const courseDoc = doc(firestore,'courses','Biology.101');
        await setDoc(courseDoc, { content: html, updatedAt: new Date().toISOString(), sourceFile: file.name });
        alert('Biology document imported and saved to Biology.101');
        // show saved
        loadSavedBiology();
      } catch (e){
        alert('Import failed: ' + e.message);
      }
    });

    // Save BIO from editor to Firestore
    saveBioBtn.addEventListener('click', async ()=>{
      const html = bioEditor.innerHTML.trim();
      if (!html) { alert('Editor is empty'); return; }
      await setDoc(doc(firestore,'courses','Biology.101'), { content: html, updatedAt: new Date().toISOString(), sourceFile: 'pasted' });
      alert('Biology content saved.');
      loadSavedBiology();
    });

    // Load saved biology content
    async function loadSavedBiology(){
      const docRef = doc(firestore,'courses','Biology.101');
      const snap = await getDoc(docRef);
      if (snap.exists()){
        const data = snap.data();
        bioSaved.innerHTML = data.content || '<div class="muted">No content</div>';
        // also show inside Biology content panel when opened
        document.getElementById('Biology.101.content').querySelector('#bioSaved').innerHTML = data.content || '<div class="muted">No content</div>';
      } else {
        bioSaved.innerHTML = '<div class="muted">No saved Biology content yet.</div>';
      }
    }

    loadBioBtn.addEventListener('click', loadSavedBiology);

    // initial load of saved biology
    loadSavedBiology();

    // Load English & Math full content into panels (placeholder content already set above)

    // Ensure the default room is loaded
    chatCourseSelect.value = 'group_chat';
    switchChatRoom('group_chat');

    // small UX: press Enter to send chat
    chatInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendChatBtn.click(); } });

    // Expose a global for debugging/moderation (optional)
    window._suc = { auth, firestore, rdb, storage };

  </script>
</body>
</html>
